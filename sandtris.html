<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>サンドトリス</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    #gameBoard {
      position: relative;
      width: 300px;
      height: 500px;
      background-color: #fff;
      border: 2px solid #000;
    }
    .block, .sand {
      position: absolute;
      width: 30px;
      height: 30px;
    }
    .sand {
      background-color: #f4a460; /* 砂の色 */
    }
    #scoreBoard {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 24px;
    }
  </style>
</head>
<body>
<div id="gameBoard">
  <div id="scoreBoard">スコア: 0</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const board = document.getElementById('gameBoard');
    const scoreBoard = document.getElementById('scoreBoard');
    const colors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3']; // 7色
    const shapes = [
      [{ x: 0, y: 0 }, { x: 30, y: 0 }, { x: 60, y: 0 }, { x: 90, y: 0 }], // I
      [{ x: 0, y: 0 }, { x: 0, y: 30 }, { x: 30, y: 30 }, { x: 60, y: 30 }], // J
      [{ x: 0, y: 30 }, { x: 30, y: 30 }, { x: 60, y: 30 }, { x: 60, y: 0 }], // L
      [{ x: 0, y: 0 }, { x: 30, y: 0 }, { x: 0, y: 30 }, { x: 30, y: 30 }], // O
      [{ x: 0, y: 30 }, { x: 30, y: 30 }, { x: 30, y: 0 }, { x: 60, y: 0 }], // S
      [{ x: 0, y: 0 }, { x: 30, y: 0 }, { x: 60, y: 0 }, { x: 30, y: 30 }], // T
      [{ x: 0, y: 0 }, { x: 30, y: 0 }, { x: 30, y: 30 }, { x: 60, y: 30 }]  // Z
    ];
    let blocks = [];
    let interval = null;
    let score = 0;
    let rotation = 0;

    function updateScore() {
      score += 10;
      scoreBoard.textContent = `スコア: ${score}`;
    }

    function checkEdgeCollision() {
      const leftEdgeBlocks = Array.from(document.querySelectorAll('.sand')).filter(block => parseInt(block.style.left) === 0);
      const rightEdgeBlocks = Array.from(document.querySelectorAll('.sand')).filter(block => parseInt(block.style.left) === 270);
      leftEdgeBlocks.forEach(leftBlock => {
        rightEdgeBlocks.forEach(rightBlock => {
          if (leftBlock.style.backgroundColor === rightBlock.style.backgroundColor) {
            board.removeChild(leftBlock);
            board.removeChild(rightBlock);
          }
        });
      });
    }

    function createBlock() {
      const color = colors[Math.floor(Math.random() * colors.length)];
      const shape = shapes[Math.floor(Math.random() * shapes.length)];
      blocks = shape.map(pos => {
        const block = document.createElement('div');
        block.className = 'block';
        block.style.backgroundColor = color;
        block.style.top = `${pos.y}px`;
        block.style.left = `${120 + pos.x}px`;
        board.appendChild(block);
        return block;
      });
    }

    function moveBlock() {
      interval = setInterval(() => {
        let canMove = true;
        blocks.forEach(block => {
          const top = parseInt(block.style.top);
          const left = parseInt(block.style.left);
          const belowBlock = Array.from(document.querySelectorAll('.sand')).find(b => parseInt(b.style.top) === top + 30 && parseInt(b.style.left) === left);
          if (top >= 470 || belowBlock) {
            canMove = false;
          }
        });

        if (canMove) {
          blocks.forEach(block => {
            const top = parseInt(block.style.top);
            block.style.top = `${top + 30}px`;
          });
        } else {
          clearInterval(interval);
          blocks.forEach(block => changeToSand(block));
          updateScore();
          checkEdgeCollision(); // 端同士の色の接触を確認
          createBlock();
          moveBlock();
        }
      }, 500);
    }

    function applyGravity() {
      const sands = Array.from(document.querySelectorAll('.sand'));
      sands.forEach(sand => {
        let top = parseInt(sand.style.top);
        let belowBlock;
        do {
          belowBlock = Array.from(document.querySelectorAll('.sand')).find(b => parseInt(b.style.top) === top + 30 && b.style.left === sand.style.left);
          if (!belowBlock && top < 470) {
            top += 30;
            sand.style.top = `${top}px`;
          }
        } while (!belowBlock && top < 470);
      });
    }

    function changeToSand(block) {
      block.classList.add('sand');
      applyGravity(); // 重力を適用
    }

    function rotateBlock(direction) {
      rotation += direction;
      blocks.forEach(block => {
        block.style.transform = `rotate(${rotation}deg)`;
      });
    }

    function handleKeyPress(e) {
      const moves = { ArrowLeft: -30, ArrowRight: 30 };
      const canMoveHorizontally = (dir) => blocks.every(block => {
        const left = parseInt(block.style.left) + dir;
        return left >= 0 && left < 300;
      });

      if (e.key in moves && canMoveHorizontally(moves[e.key])) {
        blocks.forEach(block => {
          const left = parseInt(block.style.left);
          block.style.left = `${left + moves[e.key]}px`;
        });
      } else if (e.key === 'w' || e.key === 'W') {
        rotateBlock(90); // 右回転
      } else if (e.key === 'q' || e.key === 'Q') {
        rotateBlock(-90); // 左回転
      }
    }

    document.addEventListener('keydown', handleKeyPress);

    createBlock();
    moveBlock();
  });
</script>
</body>
</html>
