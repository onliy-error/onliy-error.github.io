<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>サンドトリス</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    #gameBoard {
      position: relative;
      width: 300px;
      height: 500px;
      background-color: #fff;
      border: 2px solid #000;
    }
    .block {
      position: absolute;
      width: 30px;
      height: 30px;
    }
    .solid {
      background-color: #808080; /* 砂の代わりになるブロックの色 */
    }
    #scoreBoard {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 24px;
    }
  </style>
</head>
<body>
<div id="gameBoard">
  <div id="scoreBoard">スコア: 0</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const board = document.getElementById('gameBoard');
    const scoreBoard = document.getElementById('scoreBoard');
    const colors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3']; // 7色
    const shapes = [
      [{ x: 0, y: 0 }, { x: 30, y: 0 }, { x: 60, y: 0 }, { x: 90, y: 0 }], // I
      [{ x: 0, y: 0 }, { x: 0, y: 30 }, { x: 30, y: 30 }, { x: 60, y: 30 }], // J
      [{ x: 0, y: 30 }, { x: 30, y: 30 }, { x: 60, y: 30 }, { x: 60, y: 0 }], // L
      [{ x: 0, y: 0 }, { x: 30, y: 0 }, { x: 0, y: 30 }, { x: 30, y: 30 }], // O
      [{ x: 0, y: 30 }, { x: 30, y: 30 }, { x: 30, y: 0 }, { x: 60, y: 0 }], // S
      [{ x: 0, y: 0 }, { x: 30, y: 0 }, { x: 60, y: 0 }, { x: 30, y: 30 }], // T
      [{ x: 0, y: 0 }, { x: 30, y: 0 }, { x: 30, y: 30 }, { x: 60, y: 30 }]  // Z
    ];

    const COLS = 10;
    const ROWS = 16;
    const BLOCK_SIZE = blocks.find(blockColumnsForShape).style.width;
    const ROW_SIZE = blocks.find(blockColumnsForShape).style.height;
    let blocks = [];
    let solidBlocks = new Array(COLS).fill().map(() => new Array(ROWS).fill(null));
    let interval = null;
    let score = 0;
    let rotation = 0;

    function updateScore() {
      score += 10;
      scoreBoard.textContent = `スコア: ${score}`;
    }

    function checkEdgeCollision() {
      const leftEdgeBlocks = [...document.querySelectorAll('.solid')].filter(block => parseInt(block.style.left) === 0);
      const rightEdgeBlocks = [...document.querySelectorAll('.solid')].filter(block => parseInt(block.style.left) === 270);
      leftEdgeBlocks.forEach(leftBlock => {
        rightEdgeBlocks.forEach(rightBlock => {
          if (leftBlock.style.backgroundColor === rightBlock.style.backgroundColor) {
            board.removeChild(leftBlock);
            board.removeChild(rightBlock);
          }
        });
      });
    }

    function createBlock() {
      const color = colors[Math.floor(Math.random() * colors.length)];
      const shape = shapes[Math.floor(Math.random() * shapes.length)];
      blocks = shape.map(pos => {
        const block = document.createElement('div');
        block.className = 'block';
        block.style.backgroundColor = color;
        block.style.top = `${pos.y}px`;
        block.style.left = `${120 + pos.x}px`;
        board.appendChild(block);
        return block;
      });
    }

    function moveBlock() {
      interval = setInterval(() => {
        let canMove = true;
        blocks.forEach(block => {
          const top = parseInt(block.style.top);
          const left = parseInt(block.style.left);
          const belowBlock = Array.from(document.querySelectorAll('.solid')).find(b => parseInt(b.style.top) === top + 30 && parseInt(b.style.left) === left);
          if (top >= 470 || belowBlock) {
            canMove = false;
          }
        });

        if (canMove) {
          blocks.forEach(block => {
            const top = parseInt(block.style.top);
            block.style.top = `${top + 30}px`;
          });
        } else {
          clearInterval(interval);
          blocks.forEach(block => changeToSolids(block));
          updateScore();
          checkEdgeCollision(); // 端同士の色を確認
          createBlock();
          moveBlock();
        }
      }, 500);
    }

    function changeToSolids(block) {
      const top = parseInt(block.style.top);
      const left = parseInt(block.style.left);
      const solid = document.createElement('div');
      solid.className = 'solid';
      solid.style.backgroundColor = block.style.backgroundColor;
      solid.style.top = `${top}px`;
      solid.style.left = `${left}px`;
      board.removeChild(block);
      board.appendChild(solid);
      solidBlocks[Math.floor(left / BLOCK_SIZE)][Math.floor(top / ROW_SIZE)] = solid;
    }

    function rotateBlock(direction) {
      rotation += direction;
      blocks.forEach(block => block.style.transform = `rotate(${rotation}deg)`);
    }

    function handleKeyPress(e) {
      const moves = { ArrowLeft: -30, ArrowRight: 30 };
      const canMoveHorizontally = (dir) => blocks.every(block => {
        const left = parseInt(block.style.left) + dir;
        const top = parseInt(block.style.top);
        return left >= 0 && left < 300 && !solidBlocks[Math.floor((left + dir) / BLOCK_SIZE)][Math.floor(top / ROW_SIZE)];
      });

      if (e.key in moves && canMoveHorizontally(moves[e.key])) {
        blocks.forEach(block => {
          let left = parseInt(block.style.left);
          left += moves[e.key];
          block.style.left = `${left}px`;
        });
      } else if (e.key === 'w' || e.key === 'W') {
        rotateBlock(90); // 右回転
      } else if (e.key === 'q' || e.key === 'Q') {
        rotateBlock(-90); // 左回転
      }
    }

    document.addEventListener('keydown', handleKeyPress);

    createBlock();
    moveBlock();
  });
</script>
</body>
</html>
